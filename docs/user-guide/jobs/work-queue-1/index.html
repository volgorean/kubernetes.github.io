

<!Doctype html>
<html id="docs" class="Guides">


<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="canonical" href="http://kubernetes.io/docs/user-guide/jobs/work-queue-1/" />
	<link rel="shortcut icon" type="image/png" href="/images/favicon.png">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href='https://fonts.googleapis.com/css?family=Roboto+Mono' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
        <link rel="stylesheet" href="/css/jquery-ui.min.css">
        <link rel="stylesheet" href="/css/sweetalert.css">
	<script src="/js/jquery-2.2.0.min.js"></script>
        <script src="/js/jquery-ui.min.js"></script>
	<script src="/js/script.js"></script>
        <script src="/js/sweetalert.min.js"></script>
	<title>Kubernetes - Coarse Parallel Processing using a Work Queue</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs/" class="button" id="viewDocs" data-auto-burger-exclude>View Documentation</a>
		<a href="/docs/hellonode/" class="button" id="tryKubernetes" data-auto-burger-exclude>Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="/docs/hellonode/">Get Started</a></h3>
				<p>Ready to get your hands dirty? Build a simple Kubernetes cluster that runs "Hello World" for Node.js.</p>
			</div>
			<div class="nav-box">
				<h3><a href="/docs/">Documentation</a></h3>
				<p>Learn how to use Kubernetes with the use of walkthroughs, samples, and reference documentation. You can even <a href="/editdocs/" data-auto-burger-exclude>help contribute to the docs</a>!</p>
			</div>
			<div class="nav-box">
				<h3><a href="/community/">Community</a></h3>
				<p>If you need help, you can connect with other Kubernetes users and the Kubernetes authors, attend community events, and watch video presentations from around the web.</p>
			</div>
			<div class="nav-box">
				<h3><a href="http://blog.kubernetes.io">Blog</a></h3>
				<p>Read the latest news for Kubernetes and the containers space in general, and get technical how-tos hot off the presses.</p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="https://github.com/kubernetes/kubernetes" class="button" data-auto-burger-exclude>View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
					<a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>


<!--  HERO  -->
<section id="hero" class="light-text">
	<h1>Guides</h1>
	<h5>How to get started, and achieve tasks, using Kubernetes</h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/docs/" class="YAH">GUIDES</a></li>
			<li><a href="/docs/reference" >REFERENCE</a></li>
			<li><a href="/docs/samples" >SAMPLES</a></li>
			<li><a href="/docs/troubleshooting/" >SUPPORT</a></li>
		</ul>
		<div id="searchBox">
			<input type="text" id="search" placeholder="Search" onkeydown="if (event.keyCode==13) window.location.replace('/docs/search/?q=' + this.value)">
		</div>
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
        
    <a class="item" data-title="Guides" href="/docs/"></a>
<div class="item" data-title="Getting Started">
  <div class="container">
    <a class="item" data-title="What is Kubernetes?" href="/docs/whatisk8s/"></a>
    <a class="item" data-title="Downloading or Building Kubernetes" href="/docs/getting-started-guides/binary_release/"></a>
    <a class="item" data-title="Hello World Walkthrough" href="/docs/hellonode/"></a>
    <a class="item" data-title="Online Training Course" href="https://www.udacity.com/course/scalable-microservices-with-kubernetes--ud615" target='_blank'></a>
  </div>
</div>
<div class="item" data-title="Accessing the Cluster">
  <div class="container">
    <a class="item" data-title="Installing and Setting up kubectl" href="/docs/user-guide/prereqs/"></a>
    <a class="item" data-title="Accessing Clusters" href="/docs/user-guide/accessing-the-cluster/"></a>
    <a class="item" data-title="Sharing Cluster Access with kubeconfig" href="/docs/user-guide/sharing-clusters/"></a>
    <a class="item" data-title="Authenticating Across Clusters with kubeconfig" href="/docs/user-guide/kubeconfig-file/"></a>
  </div>
</div>
    <a class="item" data-title="User Guide" href="/docs/user-guide/"></a>
    <a class="item" data-title="Web UI (Dashboard)" href="/docs/user-guide/ui/"></a>
<div class="item" data-title="Workload Deployment and Management">
  <div class="container">
    <a class="item" data-title="Launching, Exposing, and Killing Applications" href="/docs/user-guide/quick-start/"></a>
    <a class="item" data-title="Deploying Applications" href="/docs/user-guide/deploying-applications/"></a>
    <a class="item" data-title="Managing Resources" href="/docs/user-guide/managing-deployments/"></a>
    <a class="item" data-title="Replication Controller Operations" href="/docs/user-guide/replication-controller/operations/"></a>
    <a class="item" data-title="Resizing a Replication Controller" href="/docs/user-guide/resizing-a-replication-controller/"></a>
    <a class="item" data-title="Rolling Updates" href="/docs/user-guide/rolling-updates/"></a>
    <a class="item" data-title="Rolling Update Demo" href="/docs/user-guide/update-demo/"></a>
    <a class="item" data-title="Secrets Walkthrough" href="/docs/user-guide/secrets/walkthrough/"></a>
    <a class="item" data-title="Using ConfigMap" href="/docs/user-guide/configmap/"></a>
    <a class="item" data-title="Horizontal Pod Autoscaling" href="/docs/user-guide/horizontal-pod-autoscaling/walkthrough/"></a>
    <a class="item" data-title="Best Practices for Configuration" href="/docs/user-guide/config-best-practices/"></a>
    <a class="item" data-title="Using kubectl to Manage Resources" href="/docs/user-guide/working-with-resources/"></a>
    <a class="item" data-title="Garbage collection" href="/docs/user-guide/garbage-collector/"></a>
  </div>
</div>
<div class="item" data-title="Batch Jobs">
  <div class="container">
    <a class="item" data-title="Jobs" href="/docs/user-guide/jobs/"></a>
    <a class="item" data-title="Parallel Processing using Expansions" href="/docs/user-guide/jobs/expansions/"></a>
    <a class="item" data-title="Coarse Parallel Processing using a Work Queue" href="/docs/user-guide/jobs/work-queue-1/"></a>
    <a class="item" data-title="Fine Parallel Processing using a Work Queue" href="/docs/user-guide/jobs/work-queue-2/"></a>
  </div>
</div>
<div class="item" data-title="Service Discovery and Load Balancing">
  <div class="container">
    <a class="item" data-title="Connecting Applications with Services" href="/docs/user-guide/connecting-applications/"></a>
    <a class="item" data-title="Service Operations" href="/docs/user-guide/services/operations/"></a>
    <a class="item" data-title="Creating an External Load Balancer" href="/docs/user-guide/load-balancer/"></a>
    <a class="item" data-title="Configuring Your Cloud Provider's Firewalls" href="/docs/user-guide/services-firewalls/"></a>
    <a class="item" data-title="Cross-cluster Service Discovery using Federated Services" href="/docs/user-guide/federation/federated-services/"></a>
  </div>
</div>
<div class="item" data-title="Containers and Pods">
  <div class="container">
    <a class="item" data-title="Running Your First Containers" href="/docs/user-guide/simple-nginx/"></a>
    <a class="item" data-title="Creating Single-Container Pods" href="/docs/user-guide/pods/single-container/"></a>
    <a class="item" data-title="Creating Multi-Container Pods" href="/docs/user-guide/pods/multi-container/"></a>
    <a class="item" data-title="Configuring Containers" href="/docs/user-guide/configuring-containers/"></a>
    <a class="item" data-title="Working with Containers in Production" href="/docs/user-guide/production-pods/"></a>
    <a class="item" data-title="Commands and Capabilities" href="/docs/user-guide/containers/"></a>
    <a class="item" data-title="Using Environment Variables" href="/docs/user-guide/environment-guide/"></a>
    <a class="item" data-title="Managing Compute Resources" href="/docs/user-guide/compute-resources/"></a>
    <a class="item" data-title="The Lifecycle of a Pod" href="/docs/user-guide/pod-states/"></a>
    <a class="item" data-title="Checking Pod Health" href="/docs/user-guide/liveness/"></a>
    <a class="item" data-title="Container Lifecycle Hooks" href="/docs/user-guide/container-environment/"></a>
    <a class="item" data-title="Assigning Pods to Nodes" href="/docs/user-guide/node-selection/"></a>
    <a class="item" data-title="Using the Downward API to Convey Pod Properties" href="/docs/user-guide/downward-api/"></a>
    <a class="item" data-title="Downward API Volumes" href="/docs/user-guide/downward-api/volume"></a>
    <a class="item" data-title="Persistent Volumes Walkthrough" href="/docs/user-guide/persistent-volumes/walkthrough/"></a>
    <a class="item" data-title="Bootstrapping Pet Sets" href="/docs/user-guide/petset/bootstrapping/"></a>
  </div>
</div>
<div class="item" data-title="Monitoring, Logging, and Debugging Containers">
  <div class="container">
    <a class="item" data-title="Resource Usage Monitoring" href="/docs/user-guide/monitoring/"></a>
    <a class="item" data-title="Logging" href="/docs/getting-started-guides/logging/"></a>
    <a class="item" data-title="Logging with Elasticsearch and Kibana" href="/docs/getting-started-guides/logging-elasticsearch/"></a>
    <a class="item" data-title="Running Commands in a Container with kubectl exec" href="/docs/user-guide/getting-into-containers/"></a>
    <a class="item" data-title="Connect with Proxies" href="/docs/user-guide/connecting-to-applications-proxy/"></a>
    <a class="item" data-title="Connect with Port Forwarding" href="/docs/user-guide/connecting-to-applications-port-forward/"></a>
    <a class="item" data-title="Using Explorer to Examine the Runtime Environment" href="https://github.com/kubernetes/kubernetes/tree/release-1.3/examples/explorer" target='_blank'></a>
  </div>
</div>
<div class="item" data-title="Creating a Cluster">
  <div class="container">
    <a class="item" data-title="Picking the Right Solution" href="/docs/getting-started-guides/"></a>
<div class="item" data-title="Running Kubernetes on Your Local Machine">
  <div class="container">
    <a class="item" data-title="Running Kubernetes Locally via Minikube" href="/docs/getting-started-guides/minikube/"></a>
    <a class="item" data-title="Deprecated Alternatives" href="/docs/getting-started-guides/alternatives/"></a>
  </div>
</div>
<div class="item" data-title="Running Kubernetes on Turn-key Cloud Solutions">
  <div class="container">
    <a class="item" data-title="Running Kubernetes on Google Container Engine" href="https://cloud.google.com/container-engine/docs/before-you-begin/" target='_blank'></a>
    <a class="item" data-title="Running Kubernetes on Google Compute Engine" href="/docs/getting-started-guides/gce/"></a>
    <a class="item" data-title="Running Kubernetes on AWS EC2" href="/docs/getting-started-guides/aws/"></a>
    <a class="item" data-title="Running Kubernetes on Azure (Weave-based)" href="/docs/getting-started-guides/coreos/azure/"></a>
    <a class="item" data-title="Running Kubernetes on Azure (Flannel-based)" href="/docs/getting-started-guides/azure/"></a>
    <a class="item" data-title="Running Kubernetes on CenturyLink Cloud" href="/docs/getting-started-guides/clc/"></a>
  </div>
</div>
<div class="item" data-title="Running Kubernetes on Custom Solutions">
  <div class="container">
    <a class="item" data-title="Creating a Custom Cluster from Scratch" href="/docs/getting-started-guides/scratch/"></a>
<div class="item" data-title="Custom Cloud Solutions">
  <div class="container">
    <a class="item" data-title="CoreOS on AWS or GCE" href="/docs/getting-started-guides/coreos/"></a>
    <a class="item" data-title="Ubuntu on AWS or Joyent" href="/docs/getting-started-guides/juju/"></a>
    <a class="item" data-title="CoreOS on Rackspace" href="/docs/getting-started-guides/rackspace/"></a>
  </div>
</div>
<div class="item" data-title="On-Premise VMs">
  <div class="container">
    <a class="item" data-title="CoreOS on Vagrant" href="/docs/getting-started-guides/coreos/"></a>
    <a class="item" data-title="Cloudstack" href="/docs/getting-started-guides/cloudstack/"></a>
    <a class="item" data-title="VMware vSphere" href="/docs/getting-started-guides/vsphere/"></a>
    <a class="item" data-title="VMware Photon Controller" href="/docs/getting-started-guides/photon-controller/"></a>
    <a class="item" data-title="Juju" href="/docs/getting-started-guides/juju/"></a>
    <a class="item" data-title="DCOS" href="/docs/getting-started-guides/dcos/"></a>
    <a class="item" data-title="CoreOS on libvirt" href="/docs/getting-started-guides/libvirt-coreos/"></a>
    <a class="item" data-title="oVirt" href="/docs/getting-started-guides/ovirt/"></a>
    <a class="item" data-title="OpenStack Heat" href="/docs/getting-started-guides/openstack-heat/"></a>
    <a class="item" data-title="CoreOS on Multinode Cluster" href="/docs/getting-started-guides/coreos/coreos_multinode_cluster/"></a>
    <a class="item" data-title="Fedora With Calico Networking" href="/docs/getting-started-guides/fedora/fedora-calico/"></a>
<div class="item" data-title="rkt">
  <div class="container">
    <a class="item" data-title="Running Kubernetes with rkt" href="/docs/getting-started-guides/rkt/"></a>
    <a class="item" data-title="Known Issues when Using rkt" href="/docs/getting-started-guides/rkt/notes/"></a>
  </div>
</div>
    <a class="item" data-title="Kubernetes on Mesos" href="/docs/getting-started-guides/mesos/"></a>
    <a class="item" data-title="Kubernetes on Mesos on Docker" href="/docs/getting-started-guides/mesos-docker/"></a>
  </div>
</div>
<div class="item" data-title="Bare Metal">
  <div class="container">
    <a class="item" data-title="Offline" href="/docs/getting-started-guides/coreos/bare_metal_offline/"></a>
    <a class="item" data-title="Fedora via Ansible" href="/docs/getting-started-guides/fedora/fedora_ansible_config/"></a>
    <a class="item" data-title="Fedora (Single Node)" href="/docs/getting-started-guides/fedora/fedora_manual_config/"></a>
    <a class="item" data-title="Fedora (Multi Node)" href="/docs/getting-started-guides/fedora/flannel_multi_node_cluster/"></a>
    <a class="item" data-title="CentOS" href="/docs/getting-started-guides/centos/centos_manual_config/"></a>
    <a class="item" data-title="CoreOS" href="/docs/getting-started-guides/coreos"></a>
    <a class="item" data-title="CoreOS with Calico" href="/docs/getting-started-guides/coreos/bare_metal_calico/"></a>
    <a class="item" data-title="Ubuntu" href="/docs/getting-started-guides/ubuntu/"></a>
    <a class="item" data-title="Ubuntu Nodes with Calico" href="/docs/getting-started-guides/ubuntu-calico/"></a>
  </div>
</div>
  </div>
</div>
    <a class="item" data-title="Portable Multi-Node Cluster" href="/docs/getting-started-guides/docker-multinode/"></a>
    <a class="item" data-title="Building Large Clusters" href="/docs/admin/cluster-large/"></a>
    <a class="item" data-title="Running in Multiple Zones" href="/docs/admin/multiple-zones/"></a>
    <a class="item" data-title="Building High-Availability Clusters" href="/docs/admin/high-availability/"></a>
  </div>
</div>
<div class="item" data-title="Administering Clusters">
  <div class="container">
    <a class="item" data-title="Admin Guide" href="/docs/admin/"></a>
    <a class="item" data-title="Cluster Management Guide" href="/docs/admin/cluster-management/"></a>
    <a class="item" data-title="Sharing a Cluster with Namespaces" href="/docs/admin/namespaces/"></a>
    <a class="item" data-title="Namespaces Walkthrough" href="/docs/admin/namespaces/walkthrough/"></a>
    <a class="item" data-title="Setting Pod CPU and Memory Limits" href="/docs/admin/limitrange/"></a>
    <a class="item" data-title="Understanding Resource Quotas" href="/docs/admin/resourcequota/"></a>
    <a class="item" data-title="Applying Resource Quotas and Limits" href="/docs/admin/resourcequota/walkthrough/"></a>
    <a class="item" data-title="Kubernetes Components" href="/docs/admin/cluster-components/"></a>
    <a class="item" data-title="Configuring Kubernetes Use of etcd" href="/docs/admin/etcd/"></a>
    <a class="item" data-title="Federating Clusters" href="/docs/admin/federation/"></a>
    <a class="item" data-title="Using Multiple Clusters" href="/docs/admin/multi-cluster/"></a>
    <a class="item" data-title="Changing Cluster Size" href="https://github.com/kubernetes/kubernetes/wiki/User-FAQ#how-do-i-change-the-size-of-my-cluster/" target='_blank'></a>
    <a class="item" data-title="Configuring Multiple Schedulers" href="/docs/admin/multiple-schedulers/"></a>
    <a class="item" data-title="Networking in Kubernetes" href="/docs/admin/networking/"></a>
    <a class="item" data-title="Using DNS Pods and Services" href="/docs/admin/dns/"></a>
    <a class="item" data-title="Setting Up and Configuring DNS" href="https://github.com/kubernetes/kubernetes/tree/release-1.3/examples/cluster-dns" target='_blank'></a>
    <a class="item" data-title="Master <-> Node Communication" href="/docs/admin/master-node-communication/"></a>
    <a class="item" data-title="Network Plugins" href="/docs/admin/network-plugins/"></a>
    <a class="item" data-title="Static Pods" href="/docs/admin/static-pods/"></a>
    <a class="item" data-title="Configuring kubelet Garbage Collection" href="/docs/admin/garbage-collection/"></a>
    <a class="item" data-title="Configuring Out Of Resource Handling" href="/docs/admin/out-of-resource/"></a>
    <a class="item" data-title="Configuring Kubernetes with Salt" href="/docs/admin/salt/"></a>
    <a class="item" data-title="Monitoring Node Health" href="/docs/admin/node-problem/"></a>
  </div>
</div>
        </div> <!-- /pi-accordion -->
		<button class="push-menu-close-button" onclick="kub.toggleToc()"></button>
	</div> <!-- /docsToc -->
	<div id="docsContent">
        <p><a href="/editdocs#docs/user-guide/jobs/work-queue-1/index.md" id="editPageButton">Edit This Page</a></p>
    	<h1>Coarse Parallel Processing using a Work Queue</h1>
		<ul id="markdown-toc">
  <li><a href="#example-job-with-work-queue-with-pod-per-work-item" id="markdown-toc-example-job-with-work-queue-with-pod-per-work-item">Example: Job with Work Queue with Pod Per Work Item</a>    <ul>
      <li><a href="#starting-a-message-queue-service" id="markdown-toc-starting-a-message-queue-service">Starting a message queue service</a></li>
      <li><a href="#testing-the-message-queue-service" id="markdown-toc-testing-the-message-queue-service">Testing the message queue service</a></li>
      <li><a href="#filling-the-queue-with-tasks" id="markdown-toc-filling-the-queue-with-tasks">Filling the Queue with tasks</a></li>
      <li><a href="#create-an-image" id="markdown-toc-create-an-image">Create an Image</a></li>
      <li><a href="#defining-a-job" id="markdown-toc-defining-a-job">Defining a Job</a></li>
      <li><a href="#running-the-job" id="markdown-toc-running-the-job">Running the Job</a></li>
      <li><a href="#alternatives" id="markdown-toc-alternatives">Alternatives</a></li>
      <li><a href="#caveats" id="markdown-toc-caveats">Caveats</a></li>
    </ul>
  </li>
</ul>

<h1 id="example-job-with-work-queue-with-pod-per-work-item">Example: Job with Work Queue with Pod Per Work Item</h1>

<p>In this example, we will run a Kubernetes Job with multiple parallel
worker processes.  You may want to be familiar with the basic,
non-parallel, use of <a href="/docs/user-guide/jobs">Job</a> first.</p>

<p>In this example, as each pod is created, it picks up one unit of work
from a task queue, completes it, deletes it from the queue, and exits.</p>

<p>Here is an overview of the steps in this example:</p>

<ol>
  <li><strong>Start a message queue service.</strong>  In this example, we use RabbitMQ, but you could use another
  one.  In practice you would set up a message queue service once and reuse it for many jobs.</li>
  <li><strong>Create a queue, and fill it with messages.</strong>  Each message represents one task to be done.  In
  this example, a message is just an integer that we will do a lengthy computation on.</li>
  <li><strong>Start a Job that works on tasks from the queue</strong>.  The Job starts several pods.  Each pod takes
  one task from the message queue, processes it, and repeats until the end of the queue is reached.</li>
</ol>

<h2 id="starting-a-message-queue-service">Starting a message queue service</h2>

<p>This example uses RabbitMQ, but it should be easy to adapt to another AMQP-type message service.</p>

<p>In practice you could set up a message queue service once in a
cluster and reuse it for many jobs, as well as for long-running services.</p>

<p>Start RabbitMQ as follows:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl create -f examples/celery-rabbitmq/rabbitmq-service.yaml
service <span class="s2">"rabbitmq-service"</span> created
<span class="gp">$ </span>kubectl create -f examples/celery-rabbitmq/rabbitmq-controller.yaml
replicationController <span class="s2">"rabbitmq-controller"</span> created
</code></pre>
</div>

<p>We will only use the rabbitmq part from the celery-rabbitmq example.</p>

<h2 id="testing-the-message-queue-service">Testing the message queue service</h2>

<p>Now, we can experiment with accessing the message queue.  We will
create a temporary interactive pod, install some tools on it,
and experiment with queues.</p>

<p>First create a temporary interactive Pod.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># Create a temporary interactive container</span>
<span class="gp">$ </span>kubectl run -i --tty temp --image ubuntu:14.04
Waiting <span class="k">for </span>pod default/temp-loe07 to be running, status is Pending, pod ready: <span class="nb">false</span>
... <span class="o">[</span> previous line repeats several <span class="nb">times</span> .. hit <span class="k">return </span>when it stops <span class="o">]</span> ...
</code></pre>
</div>

<p>Note that your pod name and command prompt will be different.</p>

<p>Next install the <code class="highlighter-rouge">amqp-tools</code> so we can work with message queues.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># Install some tools</span>
<span class="gp">root@temp-loe07:/# </span>apt-get update
.... <span class="o">[</span> lots of output <span class="o">]</span> ....
<span class="gp">root@temp-loe07:/# </span>apt-get install -y curl ca-certificates amqp-tools python dnsutils
.... <span class="o">[</span> lots of output <span class="o">]</span> ....
</code></pre>
</div>

<p>Later, we will make a docker image that includes these packages.</p>

<p>Next, we will check that we can discover the rabbitmq service:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Note the rabitmq-service has a DNS name, provided by Kubernetes:

root@temp-loe07:/# nslookup rabbitmq-service
Server:		10.0.0.10
Address:	10.0.0.10#53

Name:	rabbitmq-service.default.svc.cluster.local
Address: 10.0.147.152

# Your address will vary.
</code></pre>
</div>

<p>If Kube-DNS is not setup correctly, the previous step may not work for you.
You can also find the service IP in an env var:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># env | grep RABBIT | grep HOST
RABBITMQ_SERVICE_SERVICE_HOST=10.0.147.152
# Your address will vary.
</code></pre>
</div>

<p>Next we will verify we can create a queue, and publish and consume messages.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># In the next line, rabbitmq-service is the hostname where the rabbitmq-service</span>
<span class="c"># can be reached.  5672 is the standard port for rabbitmq.</span>

<span class="gp">root@temp-loe07:/# </span><span class="nv">BROKER_URL</span><span class="o">=</span>amqp://guest:guest@rabbitmq-service:5672
<span class="c"># If you could not resolve "rabbitmq-service" in the previous step,</span>
<span class="c"># then use this command instead:</span>
<span class="c"># root@temp-loe07:/# BROKER_URL=amqp://guest:guest@$RABBITMQ_SERVICE_SERVICE_HOST:5672</span>

<span class="c"># Now create a queue:</span>

<span class="gp">root@temp-loe07:/# </span>/usr/bin/amqp-declare-queue --url<span class="o">=</span><span class="nv">$BROKER_URL</span> -q foo -d
foo

<span class="c"># Publish one message to it:</span>

<span class="gp">root@temp-loe07:/# </span>/usr/bin/amqp-publish --url<span class="o">=</span><span class="nv">$BROKER_URL</span> -r foo -p -b Hello

<span class="c"># And get it back.</span>

<span class="gp">root@temp-loe07:/# </span>/usr/bin/amqp-consume --url<span class="o">=</span><span class="nv">$BROKER_URL</span> -q foo -c 1 cat <span class="o">&amp;&amp;</span> <span class="nb">echo
</span>Hello
root@temp-loe07:/#
</code></pre>
</div>

<p>In the last command, the <code class="highlighter-rouge">amqp-consume</code> tool takes one message (<code class="highlighter-rouge">-c 1</code>)
from the queue, and passes that message to the standard input of an
an arbitrary command.  In this case, the program <code class="highlighter-rouge">cat</code> is just printing
out what it gets on the standard input, and the echo is just to add a carriage
return so the example is readable.</p>

<h2 id="filling-the-queue-with-tasks">Filling the Queue with tasks</h2>

<p>Now lets fill the queue with some “tasks”.  In our example, our tasks are just strings to be
printed.</p>

<p>In a practice, the content of the messages might be:</p>

<ul>
  <li>names of files to that need to be processed</li>
  <li>extra flags to the program</li>
  <li>ranges of keys in a database table</li>
  <li>configuration parameters to a simulation</li>
  <li>frame numbers of a scene to be rendered</li>
</ul>

<p>In practice, if there is large data that is needed in a read-only mode by all pods
of the Job, you will typically put that in a shared file system like NFS and mount
that readonly on all the pods, or the program in the pod will natively read data from
a cluster file system like HDFS.</p>

<p>For our example, we will create the queue and fill it using the amqp command line tools.
In practice, you might write a program to fill the queue using an amqp client library.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>/usr/bin/amqp-declare-queue --url<span class="o">=</span><span class="nv">$BROKER_URL</span> -q job1  -d
job1
<span class="gp">$ </span><span class="k">for </span>f <span class="k">in </span>apple banana cherry date fig grape lemon melon
<span class="k">do</span>
  /usr/bin/amqp-publish --url<span class="o">=</span><span class="nv">$BROKER_URL</span> -r job1 -p -b <span class="nv">$f</span>
<span class="k">done</span>
</code></pre>
</div>

<p>So, we filled the queue with 8 messages.</p>

<h2 id="create-an-image">Create an Image</h2>

<p>Now we are ready to create an image that we will run as a job.</p>

<p>We will use the <code class="highlighter-rouge">amqp-consume</code> utility to read the message
from the queue and run our actual program.  Here is a very simple
example program:</p>

<table class="includecode"><thead><tr><th><a href="https://raw.githubusercontent.com/kubernetes/kubernetes.github.io/release-1.3/docs/user-guide/job/work-queue-1/worker.py" download="worker.py"><code>worker.py</code></a><img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('worker.py')" title="Copy worker.py to clipboard" /></th></tr></thead>
<tr><td>
<div id="worker.py" class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>

<span class="c"># Just prints standard out and sleeps for 10 seconds.</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Processing "</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">lines</span><span class="p">())</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre>
</div>
</td></tr></table>

<p>Now, build an an image.  If you are working in the source
tree, then change directory to <code class="highlighter-rouge">examples/job/work-queue-1</code>.
Otherwise, make a temporary directory, change to it,
download the <a href="Dockerfile?raw=true">Dockerfile</a>,
and <a href="worker.py?raw=true">worker.py</a>.  In either case,
build the image with this command: `</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>docker build -t job-wq-1 .
</code></pre>
</div>

<p>For the <a href="https://hub.docker.com/">Docker Hub</a>, tag your app image with
your username and push to the Hub with the below commands. Replace
<code class="highlighter-rouge">&lt;username&gt;</code> with your Hub username.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>docker tag job-wq-1 &lt;username&gt;/job-wq-1
docker push &lt;username&gt;/job-wq-1
</code></pre>
</div>

<p>If you are using <a href="https://cloud.google.com/tools/container-registry/">Google Container
Registry</a>, tag
your app image with your project ID, and push to GCR. Replace
<code class="highlighter-rouge">&lt;project&gt;</code> with your project ID.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>docker tag job-wq-1 gcr.io/&lt;project&gt;/job-wq-1
gcloud docker push gcr.io/&lt;project&gt;/job-wq-1
</code></pre>
</div>

<h2 id="defining-a-job">Defining a Job</h2>

<p>Here is a job definition.  You’ll need to make a copy of the Job and edit the
image to match the name you used, and call it <code class="highlighter-rouge">./job.yaml</code>.</p>

<table class="includecode"><thead><tr><th><a href="https://raw.githubusercontent.com/kubernetes/kubernetes.github.io/release-1.3/docs/user-guide/job/work-queue-1/job.yaml" download="job.yaml"><code>job.yaml</code></a><img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('job.yaml')" title="Copy job.yaml to clipboard" /></th></tr></thead>
<tr><td>
<div id="job.yaml" class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">job-wq-1</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">completions</span><span class="pi">:</span> <span class="s">8</span>
  <span class="s">parallelism</span><span class="pi">:</span> <span class="s">2</span>
  <span class="s">template</span><span class="pi">:</span>
    <span class="s">metadata</span><span class="pi">:</span>
      <span class="s">name</span><span class="pi">:</span> <span class="s">job-wq-1</span>
    <span class="s">spec</span><span class="pi">:</span>
      <span class="s">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">c</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">gcr.io/&lt;project&gt;/job-wq-1</span>
      <span class="s">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>
</code></pre>
</div>
</td></tr></table>

<p>In this example, each pod works on one item from the queue and then exits.
So, the completion count of the Job corresponds to the number of work items
done.  So we set, <code class="highlighter-rouge">.spec.completions: 8</code> for the example, since we put 8 items in the queue.</p>

<h2 id="running-the-job">Running the Job</h2>

<p>So, now run the Job:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>kubectl create -f ./job.yaml
</code></pre>
</div>

<p>Now wait a bit, then check on the job.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl describe <span class="nb">jobs</span>/job-wq-1 
Name:		job-wq-1
Namespace:	default
Image<span class="o">(</span>s<span class="o">)</span>:	gcr.io/causal-jigsaw-637/job-wq-1
Selector:	app <span class="k">in</span> <span class="o">(</span>job-wq-1<span class="o">)</span>
Parallelism:	4
Completions:	8
Labels:		<span class="nv">app</span><span class="o">=</span>job-wq-1
Pods Statuses:	0 Running / 8 Succeeded / 0 Failed
No volumes.
Events:
  FirstSeen	LastSeen	Count	From	SubobjectPath	Reason			Message
  ─────────	────────	─────	────	─────────────	──────			───────
  27s		27s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-hcobb
  27s		27s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-weytj
  27s		27s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-qaam5
  27s		27s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-b67sr
  26s		26s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-xe5hj
  15s		15s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-w2zqe
  14s		14s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-d6ppa
  14s		14s		1	<span class="o">{</span>job <span class="o">}</span>			SuccessfulCreate	Created pod: job-wq-1-p17e0
</code></pre>
</div>

<p>All our pods succeeded.  Yay.</p>

<h2 id="alternatives">Alternatives</h2>

<p>This approach has the advantage that you
do not need to modify your “worker” program to be aware that there is a work queue.</p>

<p>It does require that you run a message queue service.
If running a queue service is inconvenient, you may
want to consider one of the other <a href="/docs/user-guide/jobs/#job-patterns">job patterns</a>.</p>

<p>This approach creates a pod for every work item.  If your work items only take a few seconds,
though, creating a Pod for every work item may add a lot of overhead.  Consider another
<a href="/docs/user-guide/job/work-queue-2">example</a>, that executes multiple work items per Pod.</p>

<p>In this example, we used use the <code class="highlighter-rouge">amqp-consume</code> utility to read the message
from the queue and run our actual program.  This has the advantage that you
do not need to modify your program to be aware of the queue.
A <a href="/docs/user-guide/job/work-queue-2">different example</a>, shows how to
communicate with the work queue using a client library.</p>

<h2 id="caveats">Caveats</h2>

<p>If the number of completions is set to less than the number of items in the queue, then
not all items will be processed.</p>

<p>If the number of completions is set to more than the number of items in the queue,
then the Job will not appear to be completed, even though all items in the queue
have been processed.  It will start additional pods which will block waiting
for a mesage.</p>

<p>There is an unlikely race with this pattern.  If the container is killed in between the time
that the message is acknowledged by the amqp-consume command and the time that the container
exits with success, or if the node crashes before the kubelet is able to post the success of the pod
back to the api-server, then the Job will not appear to be complete, even though all items
in the queue have been processed.</p>

        <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/user-guide/jobs/work-queue-1/index.md?pixel" alt="Analytics" /></a>
        <div id="pd_rating_holder_8345992"></div>
		<script type="text/javascript">
	        PDRTJS_settings_8345992 = {
		        "id" : "8345992",
		        "unique_id" : "/docs/user-guide/jobs/work-queue-1/",
		        "title" : "Coarse Parallel Processing using a Work Queue",
		        "permalink" : "http://kubernetes.github.io/docs/user-guide/jobs/work-queue-1/"
	        };
	        (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
        </script>
	</div>
</section>

<footer>
	<main class="light-text">
		<nav>
			<a href="/docs/hellonode/">Get Started</a>
			<a href="/docs/">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/community/">Community</a>
		</nav>
		<div class="social">
			<div>
				<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
				<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
				<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			</div>
			<div>
				<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
				<a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
				<a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
			</div>
			<div>
				<span>I wish this page</span>
				<input type="text" id="wishField" name="wishField" placeholder="enter your wish">
			</div>
		</div>
		<div id="miceType" class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>


<button class="flyout-button" onclick="kub.toggleToc()"></button>

<style>
	.cse .gsc-control-cse, .gsc-control-cse, {
		padding: 0;
	}
	.gsc-control-cse table, .gsc-control-cse-en table {
		margin:0px !important;
	}

	.gsc-above-wrapper-area {
		border-bottom: 0;
	}
</style>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36037335-10', 'auto');
  ga('send', 'pageview');
</script>
<!-- Commenting out AnswerDash for now; we need to work on our list of questions/answers/design first
<!-- Start of AnswerDash script <script>var AnswerDash;!function(e,t,n,s,a){if(!t.getElementById(s)){var i,r=t.createElement(n),c=t.getElementsByTagName(n)[0];e[a]||(i=e[a]=function(){i.__oninit.push(arguments)},i.__oninit=[]),r.type="text/javascript",r.async=!0,r.src="https://p1.answerdash.com/answerdash.min.js?siteid=756",r.setAttribute("id",s),c.parentNode.insertBefore(r,c)}}(window,document,"script","answerdash-script","AnswerDash");</script> <!-- End of AnswerDash script -->
</body>
</html>
